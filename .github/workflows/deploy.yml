name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          
          echo "ðŸš€ ë°°í¬ ì‹œìž‘..."
          
          # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ðŸ“¦ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì¤‘..."
          sudo apt-get update -y
          sudo apt-get install -y git curl wget unzip
          
          # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker &> /dev/null; then
            echo "ðŸ³ Docker ì„¤ì¹˜ ì¤‘..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            rm get-docker.sh
          fi
          
          # Docker ê¶Œí•œ ë¬¸ì œ í•´ê²°
          echo "ðŸ”§ Docker ê¶Œí•œ ì„¤ì • ì¤‘..."
          sudo usermod -aG docker $USER
          sudo chmod 666 /var/run/docker.sock || true
          sudo systemctl restart docker
          
          # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker-compose &> /dev/null; then
            echo "ðŸ³ Docker Compose ì„¤ì¹˜ ì¤‘..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
          echo "ðŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì • ì¤‘..."
          mkdir -p /home/ubuntu/whisperx-api
          cd /home/ubuntu/whisperx-api
          
          # Git ì„¤ì • (ì „ì—­ ì„¤ì •ì´ ì—†ëŠ” ê²½ìš°)
          git config --global user.email "deploy@github.com" || true
          git config --global user.name "Deploy Bot" || true
          
          # Git ì €ìž¥ì†Œê°€ ì—†ìœ¼ë©´ í´ë¡ , ìžˆìœ¼ë©´ pull
          if [ ! -d .git ]; then
            echo "ðŸ“¥ Git ì €ìž¥ì†Œ í´ë¡  ì¤‘..."
            git clone https://github.com/${{ github.repository }}.git .
            git checkout main
          else
            echo "ðŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          echo "ðŸ“ í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p models uploads logs
          
          # .env íŒŒì¼ ìƒì„± (HuggingFace í† í° ì„¤ì •)
          echo "ðŸ” í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
          cat > .env << EOF
          HUGGINGFACE_TOKEN=${{ secrets.HUGGINGFACE_TOKEN }}
          ENVIRONMENT=production
          LOG_LEVEL=INFO
          EOF
          
          # Docker ì„œë¹„ìŠ¤ ì‹œìž‘
          echo "ðŸ³ Docker ì„œë¹„ìŠ¤ ì‹œìž‘ ì¤‘..."
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Docker ê¶Œí•œ ìž¬ì„¤ì • (ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨)
          echo "ðŸ”§ Docker ê¶Œí•œ ìž¬ì„¤ì • ì¤‘..."
          sudo usermod -aG docker $USER
          sudo chmod 666 /var/run/docker.sock || true
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (sudo ì‚¬ìš©)
          echo "ðŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          sudo docker-compose down --remove-orphans || true
          sudo docker system prune -f || true
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì‹¤í–‰ (sudo ì‚¬ìš©)
          echo "ðŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          sudo docker-compose build --no-cache
          
          echo "ðŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹œìž‘ ì¤‘..."
          sudo docker-compose up -d
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ðŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          sleep 60
          sudo docker-compose ps
          
          # í—¬ìŠ¤ì²´í¬ (ì—¬ëŸ¬ ë²ˆ ì‹œë„) - WhisperX ëª¨ë¸ ë¡œë”© ì‹œê°„ ê³ ë ¤
          echo "ðŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘... (AI ëª¨ë¸ ë¡œë”©ìœ¼ë¡œ ì¸í•´ ì‹œê°„ì´ ì˜¤ëž˜ ê±¸ë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤)"
          for i in {1..15}; do
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/15... (ëŒ€ê¸° ì‹œê°„: $((i * 30))ì´ˆ)"
            if curl -f http://localhost:8000/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨, 30ì´ˆ í›„ ìž¬ì‹œë„... (AI ëª¨ë¸ ë¡œë”© ì¤‘ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤)"
              sleep 30
            fi
          done
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ðŸ“Š ìµœì¢… ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          sudo docker-compose ps
          
          echo "âœ… ë°°í¬ ì™„ë£Œ! http://${{ secrets.EC2_HOST }}:8000"
          echo "ðŸ“‹ ë¡œê·¸ í™•ì¸: sudo docker-compose logs -f"
